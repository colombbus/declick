image: alefesouza/php7-laravel-node-yarn

services:
  - mysql

variables:
  MYSQL_DATABASE: homestead
  MYSQL_ALLOW_EMPTY_PASSWORD: "true"
  DB_HOST: mysql
  DB_USERNAME: root
  DB_PASSWORD: ""

before_script:
  - npm i -g npm@latest
  - npm i -g lerna
  - lerna bootstrap 

cache:
  paths:
    - node_modules/

stages:
  - test
  - build
  - deploy

unit_test_objects:
  stage: test
  script:
    - cd packages/objects
    - npm run unit

unit_test_runtime:
  stage: test
  script:
    - cd packages/runtime
    - npm run unit

build_runtime:
  stage: build
  script:
    - cd packages/runtime
    - npm run build
  artifacts:
    paths:
    - packages/runtime/lib/@declick/runtime.js
    - packages/runtime/lib/@declick/runtime.js.map
    - packages/runtime/lib/@declick/runtime.min.js
    - packages/runtime/lib/@declick/runtime.min.js.map

build_objects:
  stage: build
  before_script:
    - npm i -g npm@latest
    - npm i -g lerna
    - lerna bootstrap 
  script:
    - cd packages/objects
    - npm run build
  artifacts:
    paths:
    - packages/objects/lib/@declick/objects.js
    - packages/objects/lib/@declick/objects.js.map
    - packages/objects/lib/@declick/objects.min.js
    - packages/objects/lib/@declick/objects.min.js.map

# deploy_QA:
#   stage: deploy
#   environment:
#     name: staging
#     url: "$QA_URL"
#   before_script:
#     - yarn build
#     - "which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )"
#     - eval $(ssh-agent -s)
#     - mkdir -p ~/.ssh
#     - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
#   script:
#     - ssh-add <(echo "$SSH_PRIVATE_KEY")
#     - ssh -o StrictHostKeyChecking=no user@"$QA_SERVER" rm -rf "$INSTALL_DIRECTORY"/*
#     - scp -P22 -r packages/ "$QA_USER"@"$QA_SERVER":"$INSTALL_DIRECTORY"
#   only:
#     - phaser
#
# deploy_production:
#   stage: deploy
#   environment:
#     name: production
#     url: $PRODUCTION_URL
#   only:
#     - master
#   script:
#     # Comment the following two lines if you can
#     # compile front-end stuff on your webserver,
#     # otherwise it will compile on GitLab CI and
#     # push it to a deploy branch, also remove the
#     # deploy branch on the Envoy.blade.php file
#     # - chmod +x ./build/deploy.sh
#     # - ./build/deploy.sh
#     # Run Envoy via composer to pull the changes on the deploy server
#     - composer run deploy
